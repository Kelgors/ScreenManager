!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["lodash","jquery"],function(i,s){t.screens=e(t,{},i,s)}):t.screens=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}(this,function(t,e,i,s){"use strict";function n(){this.run=i.bind(n.prototype.run,this),this.isRunning=!1,this.frame=0,this.callbacks=[],this.beforeunloadMethod=null}function o(t,e){i.extend(this,BackboneEvents),this.id=e,this.parent=t,this.$el=s(this.el=document.getElementById(e)),this.isPopin=this.$el.hasClass("popin"),this.animation=null,t.screens.push(this)}function r(t,e){return(e||new f(y,0,1)).on("start",function(){t.style.opacity="0",t.style.display="block"}).on("step",function(e){t.style.opacity=e.value}).on("stop",function(){t.style.opacity="1",t.style.display="block"})}function h(t,e){return(e||new f(y,1,0)).on("start",function(){t.style.opacity="1",t.style.display="block"}).on("step",function(e){t.style.opacity=e.value}).on("stop",function(){t.style.opacity="0",t.style.display="none"})}function c(){i.extend(this,BackboneEvents),this.screens=[],e.screens={}}function a(t){i.extend(this,BackboneEvents),this.duration=t,this.stepModulo=10,this.stepCount=0,this.beginAt=Number.MAX_VALUE}function u(t){i.extend(this,BackboneEvents),this.id=t,this.el=(this.$el=s("#"+t))[0],this.screen=new l,this.size=new l,this.ratio=new l(1,1),this.$resizeElement=isMobile?s(window):this.$el,this.updateSize=i.debounce(i.bind(this.updateSize,this),50),this.updateSize({silent:!0})}function p(t,e,s){i.extend(this,BackboneEvents),this.set(t,e,s),this.offset=0,this.lastTime=0,this.isRunning=!1}function l(t,e){t instanceof Array?(e=t[1],t=t[0]):"object"==typeof t&&i.isNumber(t.x)&&i.isNumber(t.y)&&(e=t.y,t=t.x),this.x=t||0,this.y=e||0}function f(t,e,s){i.extend(this,BackboneEvents),this.value=0,this.isRunning=!1,this.autoLoop=!1,this.run=i.bind(this.run,this),this.set(t,e,s)}n.prototype.constructor=n,n.prototype.start=function(){this.isRunning||(this.isRunning=!0,this.beforeunloadMethod||window.addEventListener("beforeunload",this.beforeunloadMethod=i.bind(this.stop,this),!1),this.loop())},n.prototype.stop=function(){this.isRunning&&(this.isRunning=!1,"number"==typeof this.frame&&(cancelAnimationFrame(this.frame),this.frame=null,this.beforeunloadMethod&&(window.removeEventListener("beforeunload",this.beforeunloadMethod,!1),this.beforeunload=null)))},n.prototype.add=function(t,e,i){i=i||{},"function"==typeof t&&this.callbacks.push({callback:t,context:e,once:i.once||!1})},n.prototype.addOnce=function(t,e){this.add(t,e,{once:!0})},n.prototype.remove=function(t,e){var s=i.identity,n=0,o=[];s=t&&e?function(i){return t===i.callback&&e===i.context}:t?function(e){return t===e.callback}:function(t){return e===t.context},o=i.filter(this.callbacks,s);for(var r in o)n+=this.callbacks.splice(this.callbacks.indexOf(o[r]),1).length;return n},n.prototype.loop=function(){this.frame=requestAnimationFrame(this.run)},n.prototype.run=function(t){var i={},s=this.callbacks.slice();e.time=t;for(var n in s)i=s[n],"function"==typeof i.callback&&(i.context?i.callback.call(i.context,t):i.callback(t)),i.once&&this.remove(i.callback,i.context);this.isRunning&&this.loop()},e.runner=new n,o.prototype.constructor=o,o.prototype.dispose=function(){this.id=this.el=this.$el=this.parent=this.isPopin=null},o.prototype.show=function(){this.animation&&this.animation.isRunning&&this.animation.stop(),this.animation=r(this.el).on("stop",function(t){this.animation===t.target&&(this.animation=null)},this).start()},o.prototype.hide=function(){this.animation&&this.animation.isRunning&&this.animation.stop(),(this.animation=h(this.el)).on("stop",function(t){this.animation===t.target&&(this.animation=null)},this).start()},o.prototype.isVisible=function(){return this.$el.is(":visible")&&!(this.animation&&this.animation.isRunning)},o.prototype.reloadAfterError=i.identity;var y=400;return c.prototype.constructor=c,c.prototype.dispose=function(){this.off(),e.runner.stop(),i.forEach(this.screens,function(t){t&&(e.screens[t.id]=null,t.dispose())}),this.viewport&&this.viewport.dispose(),this.viewport=this.screens=e.runner=null},c.prototype.initialize=function(t){e.runner.start(),this.viewport=new u("game-viewport"),window.isMobile||this.viewport.keepRatio(.625),t&&t.length&&(i.forEach(t,function(i,s){try{t[s]=e.screens[i.screenId]=new Game[i.type](instance,i.screenId)}catch(n){throw n}},this),this.screens.concat(t)),this.trigger("load",{type:"load",target:this}),this.goTo(i.first(this.screens),{noanimations:!0})},c.prototype.reset=function(){return this.initialize()},c.prototype.getDimensionAdaptedToViewport=function(t){var e=instance.viewport.size,i=new l(e.x,t.y*(e.x/t.x));return i.y>e.y&&i.setXY(t.x*(e.y/t.y),e.y),i},c.prototype.goTo=function(t,i){var s,n,o,a,u=!1,p="Screen",l="Screen";return i=i||{},t instanceof e.Level&&!t.isFetched()?(t.once("load",function(){c.get().goTo(t,i)}),void t.fetch()):(t.isPopin&&(p="Popin"),this.isPopinOver()&&(l="Popin"),n=this["current"+l],s=t,u=s===this.currentScreen||s===this.lastScreen&&null===this.currentScreen,a=s.isPopin&&n&&!n.isPopin,this["last"+l]=n,this["current"+p]=s,l!==p&&(this["current"+l]=null),n&&n.el&&(n.trigger("before:stop",{type:"before:stop",target:n,origin:this}),i.noanimations||a?(n.trigger("stop",{type:"stop",target:n,origin:this}),a||n.$el.hide()):(o=h(n.el),o.on("stop",function(){n.trigger("stop",{type:"stop",target:n,origin:this})},this),o.start())),s&&s.el&&(s.trigger("before:start",{type:"before:start",target:s,origin:this}),i.noanimations||u?(u&&s.trigger("restart",{type:"restart",target:s,origin:this}),s.trigger("start",{type:"start",target:s,origin:this}),s.$el.show()):(o=r(s.el),o.on("stop",function(){s.trigger("start",{type:"start",target:s,origin:this})},this),o.start())),this.trigger("change:screen",this),s)},c.prototype.closePopin=function(){this.goTo(this.currentScreen||this.lastScreen)},c.prototype.isPopinOver=function(){return!!this.currentPopin},c.prototype.isActiveScreen=function(t){return this.isPopinOver()?this.currentPopin===t:this.currentScreen===t},c.prototype.getNextScreen=function(){var t=i.indexOf(this.screens,this.popin||this.currentScreen);return t>-1&&this.screens.length>t+1?this.screens[t+1]:null},c.prototype.hasNextScreen=function(){return i.indexOf(this.screens,this.popin||this.currentScreen)<this.screens.length-1},c.prototype.getScreenById=function(t){return e.screens[t]||null},c.get=function(){return instance||(instance=new c)},c.dispose=function(){instance&&(instance.dispose(),instance=null)},e.createElement=function(t){for(var e=document.createElement(t.tagName||"div"),i=Object.keys(t.attributes||{}),s=-1,n=i.length;++s<n;)e.setAttribute(i[s],t.attributes[i[s]]);return t.textContent&&(e.textContent=t.textContent),e},a.prototype.constructor=a,a.prototype.dispose=function(){},a.prototype.step=function(){this.stepCount+=1,this.stepCount%this.stepModulo===0&&this.trigger("tick",this.createEvent("tick")),this.isComplete()&&(this.trigger("complete",this.createEvent("complete")),this.stop())},a.prototype.start=function(){this.isRunning||(this.beginAt=e.time,this.stepCount=0,e.runner.add(this.step,this),this.isRunning=!0,this.trigger("start",this.createEvent("start")))},a.prototype.stop=function(){this.isRunning&&(e.runner.remove(this.step,this),this.isRunning=!1,this.trigger("stop",this.createEvent("stop")))},a.prototype.restart=function(){this.isRunning?this.beginAt=e.time:this.start()},a.prototype.createEvent=function(t){return{type:t,delta:this.getDelta(),duration:this.duration,beginAt:this.beginAt,target:this}},a.prototype.getDelta=function(){return e.time-this.beginAt},a.prototype.isComplete=function(){return this.getDelta()>=this.duration},u.prototype.constructor=u,u.prototype.dispose=function(){this.off().$el.off("resize",this.updateSize),this.updateSize=this.$el=this.el=this.id=this.size=this.ratio=null},u.prototype.updateSize=function(t){this.$resizeElement.off("resize",this.updateSize),this.screen.setXY(this.$resizeElement.width(),this.$resizeElement.height()),this.size.setXY(isMobile?this.ratio.scl(this.screen):this.ratio.scl(this.screen.x,this.screen.x)),this.$resizeElement.css("height",this.size.y).css("width",this.size.x).find(".screen:not(.popin)").css("width",this.size.x).css("height",this.size.y),t.silent||this.trigger("resize",{size:this.size.clone(),screen:this.screen.clone(),origin:this}),this.$resizeElement.on("resize",this.updateSize)},u.prototype.keepRatio=function(t){this.ratio.setXY(1,t),this.updateSize({silent:!0})},p.prototype.constructor=p,p.prototype.set=function(t,e,i){this.el=t,this.textTimeline=(e||[]).slice(),this.millisecondsByChar=i||17},p.prototype.start=function(){this.isRunning||(this.lastTime=e.time,this.offset=0,e.runner.add(this.run,this),this.isRunning=!0,this.trigger("start",this.createEvent("start")))},p.prototype.stop=function(){this.isRunning&&(e.runner.remove(this.run,this),this.isRunning=!1,this.trigger("stop",this.createEvent("stop")))},p.prototype.run=function(){var t=e.time-this.lastTime;this.currentTagDescription||(this.currentTagDescription=this.textTimeline.shift(),this.offset=0,this.text=this.currentTagDescription.textContent||"",this.currentTagDescription.textContent=null,this.currentTagDescription.tagName||(this.currentTagDescription.tagName="span"),this.currentDrawingElement=e.createElement(this.currentTagDescription),this.el.appendChild(this.currentDrawingElement)),this.offset+=Math.ceil(t/this.millisecondsByChar),this.offset>this.text.length&&(this.offset=this.text.length),this.offset>0&&(this.currentDrawingElement.textContent=this.text.substr(0,this.offset)),this.offset===this.text.length&&(this.textTimeline.length?this.text=this.currentTagDescription=this.currentDrawingElement=null:(this.trigger("complete",this.createEvent("complete")),this.stop())),this.lastTime=e.time},p.prototype.createEvent=function(t){return{type:t,target:this,text:this.text,offset:this.offset,element:this.el}},l.prototype.constructor=l,l.prototype.dispose=function(){},l.prototype.clone=function(){return new l(this)},l.prototype.toString=function(){return"{ x: "+this.x+", y: "+this.y+" }"},l.prototype.add=function(t,e){return t instanceof l&&(e=t.y,t=t.x),new l(this.x+t,this.y+e)},l.prototype.sub=function(t,e){return t instanceof l&&(e=t.y,t=t.x),new l(this.x-t,this.y-e)},l.prototype.scl=function(t,e){return t instanceof l&&(e=t.y,t=t.x),new l(this.x*t,this.y*e)},l.prototype.div=function(t,e){return t instanceof l&&(e=t.y,t=t.x),new l(this.x/t,this.y/e)},l.prototype.setXY=function(t,e){t instanceof l&&(e=t.y,t=t.x),this.x=t,this.y=e},l.prototype.dst2=function(t,e){return t instanceof l&&(e=t.y,t=t.x),(t-this.x)*(t-this.x)+(e-this.y)*(e-this.y)},l.prototype.dst=function(t,e){return Math.sqrt(this.dst2(t,e))},l.prototype._useMathMethod=function(t){return new l(Math[t](this.x),Math[t](this.y))},["floor","ceil","abs"].forEach(function(t){l.prototype[t]=function(){return this._useMathMethod(t)}}),f.prototype.constructor=f,f.prototype.set=function(t,e,i){this.duration=t,this.from=e,this.to=i,this.side=this.to>this.from?1:-1,this.step=Math.abs(this.to-this.from)/(t/(50/3))},f.prototype.start=function(){this.isRunning||(this.value=this.from,this.trigger("start",this.createEvent("start")),e.runner.add(this.run,this),this.isRunning=!0)},f.prototype.restart=function(){this.isRunning?(this.value=this.from,this.trigger("restart",this.createEvent("restart"))):this.start()},f.prototype.stop=function(){this.isRunning&&(this.trigger("stop",this.createEvent("stop")),e.runner.remove(this.run,this),this.isRunning=!1)},f.prototype.run=function(){this.isComplete()?this.autoLoop||this.autoReverse?this.autoLoop?this.value=this.from+this.step-Math.abs(this.to-this.value)*this.side:this.autoReverse&&this.reverse():(this.value=this.to,this.trigger("complete",this.createEvent("complete")),this.stop()):(this.value+=this.step*this.side,this.trigger("step",this.createEvent("step")))},f.prototype.reverse=function(){var t=this.from;this.side=-this.side,this.from=this.to,this.to=t},f.prototype.createEvent=function(t){return{type:t,from:this.from,to:this.to,value:this.value,delta:this.step*this.side,duration:this.duration,target:this}},f.prototype.isComplete=function(){return 1===this.side&&this.value+this.step>this.to||-1===this.side&&this.value-this.step<this.to},f.prototype.clone=function(){var t=new f(this.duration,this.from,this.to);return this.run!==f.prototype.run&&(t.run=this.run),t},e});